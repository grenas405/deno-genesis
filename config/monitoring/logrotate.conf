# Log Rotation Configuration for DenoGenesis Framework
# ================================================================
# This configuration manages log file rotation to prevent disk space issues
# and maintain manageable log file sizes across all sites and framework components
# ================================================================

# DenoGenesis Framework Logs
/home/admin/deno-genesis/logs/*.log {
    # Rotate daily
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress rotated logs (saves disk space)
    compress
    
    # Don't compress the most recent rotated log
    delaycompress
    
    # Don't rotate if log file is empty
    notifempty
    
    # Create new log file with specific permissions
    create 0644 admin admin
    
    # Use date as suffix instead of numbers
    dateext
    
    # Don't error if log file is missing
    missingok
    
    # Copy the log file and truncate original (for active processes)
    copytruncate
    
    # Post-rotation script to notify health monitoring
    postrotate
        # Signal the framework that logs have been rotated
        /usr/bin/curl -X POST http://localhost:3000/_framework/log-rotated 2>/dev/null || true
    endscript
}

# Individual Site Logs
/home/admin/deno-genesis/sites/*/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
    
    # Site-specific post-rotation
    postrotate
        # Extract site name from path and notify
        SITE_PATH=`dirname "$1"`
        SITE_NAME=`basename "$(dirname "$SITE_PATH")"`
        /usr/bin/curl -X POST "http://localhost:3000/_framework/sites/$SITE_NAME/log-rotated" 2>/dev/null || true
    endscript
}

# Error Logs (Higher retention)
/home/admin/deno-genesis/logs/*error*.log {
    daily
    # Keep error logs longer (90 days)
    rotate 90
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
}

# Access Logs (More frequent rotation due to size)
/home/admin/deno-genesis/logs/*access*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
    
    # Clean up very old access logs (keep only compressed)
    postrotate
        # Remove uncompressed access logs older than 2 days
        find /home/admin/deno-genesis/logs/ -name "*access*.log.*" -mtime +2 ! -name "*.gz" -delete 2>/dev/null || true
    endscript
}

# System Monitoring Logs
/home/admin/deno-genesis/monitoring/*.log {
    weekly
    rotate 12
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
}

# Performance Logs
/home/admin/deno-genesis/logs/*performance*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
}

# Debug Logs (Shortest retention)
/home/admin/deno-genesis/logs/*debug*.log {
    daily
    rotate 3
    compress
    delaycompress
    notifempty
    create 0644 admin admin
    dateext
    missingok
    copytruncate
}

# Global settings
# ================================================================

# Log rotation will run daily via cron
# Add to root crontab: 0 2 * * * /usr/sbin/logrotate /home/admin/deno-genesis/config/monitoring/logrotate.conf

# To test this configuration:
# sudo logrotate -d /home/admin/deno-genesis/config/monitoring/logrotate.conf

# To force rotation for testing:
# sudo logrotate -f /home/admin/deno-genesis/config/monitoring/logrotate.conf