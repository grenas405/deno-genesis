# =============================================================================
# Deno Genesis Framework - Nginx Site Configuration
# =============================================================================
# Nginx configuration for Heavenly Roofing LLC. 
# Backend service running on port 3003
#
# File: heavenlyroofingok.nginx.conf
# Location: /etc/nginx/sites-available/heavenlyroofingok.nginx.conf
# =============================================================================

# =============================================================================
# Rate Limiting Zones
# =============================================================================
limit_req_zone $binary_remote_addr zone=heavenlyroofingok_api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=heavenlyroofingok_quote_limit:10m rate=2r/s;

# =============================================================================
# HTTPS Server Configuration
# =============================================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name www.heavenlyroofingok.com heavenlyroofingok.com;

    # SSL Configuration using Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/heavenlyroofingok.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/heavenlyroofingok.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ==========================================================================
    # Security Headers (heavenlyroofingok Standard)
    # ==========================================================================
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Content Security Policy (adjust per site needs)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:; font-src 'self'; object-src 'none'; base-uri 'self'";

    # File upload limit (adjust per business needs)
    client_max_body_size 25M;

    # ==========================================================================
    # Main Application Proxy
    # ==========================================================================
    location / {
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Standard timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ==========================================================================
    # Static Asset Optimization
    # ==========================================================================
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        
        # Cache static assets
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        
        # Enable compression
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
    }

    # ==========================================================================
    # API Rate Limiting
    # ==========================================================================
    location /api/ {
        limit_req zone=heavenlyroofingok_api_limit burst=15 nodelay;
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==========================================================================
    # WebSocket Support (if needed)
    # ==========================================================================
    location /ws {
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Extended timeouts for WebSocket connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ==========================================================================
    # File Upload Handling
    # ==========================================================================
    location /uploads/ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Extended timeouts for file uploads
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ==========================================================================
    # Quote/Contact Form with Strict Rate Limiting
    # ==========================================================================
    location /api/quote {
        limit_req zone=heavenlyroofingok_quote_limit burst=3 nodelay;
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/contact {
        limit_req zone=heavenlyroofingok_quote_limit burst=3 nodelay;
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==========================================================================
    # Security - deny access to sensitive files
    # ==========================================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /(?:\.git|\.htaccess|\.env|config\.json|package\.json|deno\.lock)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ==========================================================================
    # Health Check Endpoint
    # ==========================================================================
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ==========================================================================
    # Framework Documentation and Admin Routes
    # ==========================================================================
    location /docs/ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Optional: Add basic auth for documentation in production
        # auth_basic "heavenlyroofingok Documentation";
        # auth_basic_user_file /etc/nginx/.htpasswd;
    }

    location /admin/ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Consider adding IP restrictions for admin routes
        # allow 192.168.1.0/24;
        # deny all;
    }

    # ==========================================================================
    # Logging Configuration
    # ==========================================================================
    error_log /var/log/nginx/heavenlyroofingok_error.log;
    access_log /var/log/nginx/heavenlyroofingok_access.log;
}

# =============================================================================
# HTTP to HTTPS Redirect
# =============================================================================
server {
    listen 80;
    listen [::]:80;

    server_name www.heavenlyroofingok.com heavenlyroofing.com;

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

# =============================================================================
# DEPLOYMENT COMMANDS:
# 
# 1. Copy this file to nginx sites-available:
#    sudo cp heavenlyroofingok.nginx.conf /etc/nginx/sites-available/
# 
# 2. Create symbolic link to enable the site:
#    sudo ln -s /etc/nginx/sites-available/heavenlyroofingok.nginx.conf /etc/nginx/sites-enabled/
# 
# 3. Test nginx configuration:
#    sudo nginx -t
# 
# 4. Reload nginx if test passes:
#    sudo systemctl reload nginx
# 
# 5. Obtain SSL certificate with certbot:
#    sudo certbot --nginx -d heavenlyroofingok.com -d www.heavenlyroofing.com
# 
# LOG MONITORING:
# sudo tail -f /var/log/nginx/heavenlyroofingok_error.log
# sudo tail -f /var/log/nginx/heavenlyroofingok_access.log
# =============================================================================
